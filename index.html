<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Cucumber JSON Splitter (16MB Safe)</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f6fb;
      padding: 30px;
    }
    .box {
      max-width: 700px;
      margin: auto;
      background: #fff;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,.1);
    }
    h2 {
      margin-bottom: 10px;
    }
    input {
      margin: 15px 0;
    }
    .result {
      margin-top: 20px;
    }
    .file {
      display: flex;
      justify-content: space-between;
      background: #eef1ff;
      padding: 10px;
      margin-top: 10px;
      border-radius: 6px;
    }
    button {
      background: #667eea;
      color: #fff;
      border: none;
      padding: 6px 14px;
      border-radius: 4px;
      cursor: pointer;
    }
  </style>
</head>
<body>

<div class="box">
  <h2>ðŸ¥’ Cucumber JSON Splitter</h2>
  <p>Splits large cucumber JSON files into <b>â‰¤ 16MB</b> valid parts</p>

  <input type="file" id="fileInput" accept=".json" />

  <div class="result" id="result"></div>
</div>

<script>
const MAX_BYTES = 16 * 1024 * 1024; // 16MB
let parts = [];

document.getElementById("fileInput").addEventListener("change", async e => {
  const file = e.target.files[0];
  if (!file) return;

  const text = await file.text();
  let json;

  try {
    json = JSON.parse(text);
  } catch {
    alert("Invalid JSON");
    return;
  }

  if (
    !Array.isArray(json) ||
    !json[0]?.run?.features ||
    !Array.isArray(json[0].run.features)
  ) {
    alert("Not a valid cucumber JSON file");
    return;
  }

  splitCucumber(json, file.name);
  render();
});

function splitCucumber(original, originalName) {
  parts = [];

  const features = original[0].run.features;
  const baseName = originalName.replace(".json", "");
  let chunk = [];
  let index = 1;

  for (const feature of features) {
    const testChunk = [...chunk, feature];
    const testJson = wrap(testChunk);
    const size = new Blob([JSON.stringify(testJson)]).size;

    if (size > MAX_BYTES && chunk.length > 0) {
      pushPart(chunk, baseName, index++);
      chunk = [feature];
    } else {
      chunk.push(feature);
    }
  }

  if (chunk.length) {
    pushPart(chunk, baseName, index);
  }
}

function wrap(features) {
  return [{
    run: {
      features: features
    }
  }];
}

function pushPart(features, baseName, index) {
  const json = wrap(features);
  const blob = new Blob(
    [JSON.stringify(json, null, 2)],
    { type: "application/json" }
  );

  parts.push({
    name: `${baseName}_part${index}.json`,
    blob,
    size: blob.size,
    count: features.length
  });
}

function render() {
  const container = document.getElementById("result");
  container.innerHTML = `<h3>âœ… Split Complete (${parts.length} files)</h3>`;

  parts.forEach((p, i) => {
    const div = document.createElement("div");
    div.className = "file";
    div.innerHTML = `
      <span>${p.name} â€” ${(p.size / 1024 / 1024).toFixed(2)} MB â€” ${p.count} features</span>
      <button onclick="download(${i})">Download</button>
    `;
    container.appendChild(div);
  });
}

function download(i) {
  const a = document.createElement("a");
  a.href = URL.createObjectURL(parts[i].blob);
  a.download = parts[i].name;
  a.click();
  URL.revokeObjectURL(a.href);
}
</script>

</body>
</html>
