#!/usr/bin/env python3
"""
JSON File Splitter - Fixed Version
Splits large JSON files into smaller valid JSON parts (max 16MB each)
"""

import os
import sys
import json
import math

MAX_SIZE_MB = 16
MAX_SIZE_BYTES = MAX_SIZE_MB * 1024 * 1024

def format_bytes(bytes_size):
    """Convert bytes to human readable format"""
    for unit in ['B', 'KB', 'MB', 'GB']:
        if bytes_size < 1024.0:
            return f"{bytes_size:.2f} {unit}"
        bytes_size /= 1024.0
    return f"{bytes_size:.2f} TB"

def split_json_file(input_file):
    """Split a JSON file into valid JSON parts with max 16MB each"""
    
    print(f"\n{'='*60}")
    print(f"JSON File Splitter - Max {MAX_SIZE_MB}MB per part")
    print(f"{'='*60}\n")
    
    # Check if file exists
    if not os.path.exists(input_file):
        print(f"âŒ Error: File '{input_file}' not found!")
        return False
    
    file_size = os.path.getsize(input_file)
    print(f"ðŸ“„ Input file: {os.path.basename(input_file)}")
    print(f"ðŸ“Š File size: {format_bytes(file_size)}\n")
    
    # Check if file needs splitting
    if file_size <= MAX_SIZE_BYTES:
        print(f"âœ… File is already under {MAX_SIZE_MB}MB. No splitting needed!")
        return True
    
    # Read and parse JSON
    print("ðŸ” Reading and validating JSON file...")
    try:
        with open(input_file, 'r', encoding='utf-8') as f:
            data = json.load(f)
    except json.JSONDecodeError as e:
        print(f"âŒ Error: Invalid JSON file - {e}")
        return False
    except Exception as e:
        print(f"âŒ Error reading file: {e}")
        return False
    
    print("âœ… JSON file is valid!\n")
    
    # Determine how to split based on data type
    if isinstance(data, list):
        return split_json_array(data, input_file, file_size)
    elif isinstance(data, dict):
        return split_json_object(data, input_file, file_size)
    else:
        print("âŒ Error: JSON must be an array or object to split")
        return False

def split_json_array(data, input_file, original_size):
    """Split a JSON array into valid JSON array parts"""
    
    total_items = len(data)
    print(f"ðŸ“‹ JSON Type: Array with {total_items} items")
    
    # Calculate number of parts needed
    num_parts = math.ceil(original_size / MAX_SIZE_BYTES)
    items_per_part = math.ceil(total_items / num_parts)
    
    print(f"âœ‚ï¸  Splitting into approximately {num_parts} parts")
    print(f"ðŸ“¦ ~{items_per_part} items per part\n")
    
    # Create output directory
    base_name = os.path.splitext(os.path.basename(input_file))[0]
    output_dir = f"{base_name}_split"
    os.makedirs(output_dir, exist_ok=True)
    
    # Split the array
    parts_created = 0
    for i in range(0, total_items, items_per_part):
        part_num = parts_created + 1
        chunk = data[i:i + items_per_part]
        
        # Create valid JSON array for this part
        output_file = os.path.join(output_dir, f"{base_name}_part{part_num}.json")
        
        try:
            with open(output_file, 'w', encoding='utf-8') as f:
                json.dump(chunk, f, indent=2, ensure_ascii=False)
            
            part_size = os.path.getsize(output_file)
            print(f"âœ… Part {part_num}: {os.path.basename(output_file)} ({format_bytes(part_size)}) - {len(chunk)} items")
            parts_created += 1
            
        except Exception as e:
            print(f"âŒ Error writing part {part_num}: {e}")
            return False
    
    print(f"\nðŸŽ‰ Success! Created {parts_created} valid JSON files")
    print(f"ðŸ“ Files saved in '{output_dir}/' directory\n")
    return True

def split_json_object(data, input_file, original_size):
    """Split a JSON object into valid JSON object parts"""
    
    total_keys = len(data.keys())
    print(f"ðŸ“‹ JSON Type: Object with {total_keys} keys")
    
    # Calculate number of parts needed
    num_parts = math.ceil(original_size / MAX_SIZE_BYTES)
    keys_per_part = math.ceil(total_keys / num_parts)
    
    print(f"âœ‚ï¸  Splitting into approximately {num_parts} parts")
    print(f"ðŸ“¦ ~{keys_per_part} keys per part\n")
    
    # Create output directory
    base_name = os.path.splitext(os.path.basename(input_file))[0]
    output_dir = f"{base_name}_split"
    os.makedirs(output_dir, exist_ok=True)
    
    # Split the object
    keys = list(data.keys())
    parts_created = 0
    
    for i in range(0, total_keys, keys_per_part):
        part_num = parts_created + 1
        chunk_keys = keys[i:i + keys_per_part]
        
        # Create valid JSON object for this part
        chunk_dict = {key: data[key] for key in chunk_keys}
        
        output_file = os.path.join(output_dir, f"{base_name}_part{part_num}.json")
        
        try:
            with open(output_file, 'w', encoding='utf-8') as f:
                json.dump(chunk_dict, f, indent=2, ensure_ascii=False)
            
            part_size = os.path.getsize(output_file)
            print(f"âœ… Part {part_num}: {os.path.basename(output_file)} ({format_bytes(part_size)}) - {len(chunk_keys)} keys")
            parts_created += 1
            
        except Exception as e:
            print(f"âŒ Error writing part {part_num}: {e}")
            return False
    
    print(f"\nðŸŽ‰ Success! Created {parts_created} valid JSON files")
    print(f"ðŸ“ Files saved in '{output_dir}/' directory\n")
    return True

def main():
    print("\n" + "="*60)
    print("JSON FILE SPLITTER - VALID JSON OUTPUT")
    print("="*60)
    
    # Check if file was provided as argument
    if len(sys.argv) > 1:
        input_file = sys.argv[1]
    else:
        # Prompt for file path
        print("\nDrag and drop your JSON file here (or type the path):")
        input_file = input().strip()
        
        # Remove quotes if present (from drag-drop)
        input_file = input_file.strip('"').strip("'")
    
    # Process the file
    success = split_json_file(input_file)
    
    # Wait for user input before closing (so window doesn't close immediately)
    if success:
        input("\nPress Enter to exit...")
    else:
        input("\nPress Enter to exit...")
        sys.exit(1)

if __name__ == "__main__":
    main()
